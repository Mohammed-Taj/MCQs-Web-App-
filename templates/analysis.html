{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="fas fa-chart-bar me-2 text-primary"></i>Quiz Analytics Dashboard</h2>
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportDropdown"
                data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-download me-2"></i>Export Data
            </button>
            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                <li><a class="dropdown-item" href="#"><i class="fas fa-file-csv me-2"></i>CSV</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>PDF Report</a></li>
            </ul>
        </div>
    </div>

    <!-- Overall Stats -->
    <div class="row mb-5">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3 dashboard-stat stat-admin">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Quizzes</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ total_quizzes }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3 dashboard-stat stat-student">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">Total Students</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ total_students }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3 dashboard-stat stat-quiz">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-info text-uppercase mb-1">Total Attempts</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ total_results }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 py-3 dashboard-stat stat-question">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">Total Questions</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">{{ total_questions }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-question-circle fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Quiz Results Table -->
        <div class="col-lg-8 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h5 class="m-0 fw-bold text-primary"><i class="fas fa-list-alt me-2"></i>Quiz Results</h5>
                    <div class="d-flex gap-2">
                        <input type="text" id="searchInput" class="form-control form-control-sm"
                            placeholder="Search...">
                        <select class="form-select form-select-sm" id="quizFilter">
                            <option value="">All Quizzes</option>
                            {% for quiz in quiz_list %}
                            <option value="{{ quiz.id }}">{{ quiz.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="resultsTable">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Quiz</th>
                                    <th>Student</th>
                                    <th>Score</th>
                                    <th>Percentage</th>
                                    <th class="text-end pe-4">Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for result in results %}
                                <tr>
                                    <td class="ps-4 fw-bold">{{ result.quiz.title }}</td>
                                    <td>{{ result.student.username }}</td>
                                    <td>
                                        <span
                                            class="badge {% if (result.score / result.total * 100) >= 80 %}bg-success{% elif (result.score / result.total * 100) >= 50 %}bg-warning{% else %}bg-danger{% endif %} rounded-pill">
                                            {{ result.score }}/{{ result.total }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 6px; width: 80px;">
                                            <div class="progress-bar {% if (result.score / result.total * 100) >= 80 %}bg-success{% elif (result.score / result.total * 100) >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                                role="progressbar"
                                                style="width: {{ (result.score / result.total * 100) }}%;"
                                                aria-valuenow="{{ (result.score / result.total * 100) }}"
                                                aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <small class="text-muted">{{ "%.1f"|format((result.score / result.total * 100)
                                            if result.total > 0 else 0) }}%</small>
                                    </td>
                                    <td class="text-end pe-4">
                                        <small class="text-muted">{{ result.timestamp.strftime("%Y-%m-%d %H:%M")
                                            }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">Showing {{ results|length }} results</div>
                        <nav aria-label="Results pagination">
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                                <li class="page-item"><a class="page-link" href="#">Next</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Summary -->
        <div class="col-lg-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 fw-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Performance Summary</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <canvas id="performanceChart" width="200" height="200"></canvas>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <h3 class="mb-0 fw-bold">{{ (average_score * 100)|round(1) }}%</h3>
                                <small class="text-muted">Average</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">Excellent (80-100%)</span>
                            <span class="fw-bold">{{ excellent_count }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" role="progressbar"
                                style="width: {{ (excellent_count / total_results * 100) if total_results > 0 else 0 }}%;"
                                aria-valuenow="{{ excellent_count }}" aria-valuemin="0"
                                aria-valuemax="{{ total_results }}"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">Good (50-79%)</span>
                            <span class="fw-bold">{{ good_count }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar"
                                style="width: {{ (good_count / total_results * 100) if total_results > 0 else 0 }}%;"
                                aria-valuenow="{{ good_count }}" aria-valuemin="0" aria-valuemax="{{ total_results }}">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">Needs Improvement (0-49%)</span>
                            <span class="fw-bold">{{ poor_count }}</span>
                        </div>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-danger" role="progressbar"
                                style="width: {{ (poor_count / total_results * 100) if total_results > 0 else 0 }}%;"
                                aria-valuenow="{{ poor_count }}" aria-valuemin="0" aria-valuemax="{{ total_results }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .dashboard-stat {
        border-left: 4px solid transparent;
        transition: var(--transition);
    }

    .stat-admin {
        border-left-color: var(--primary) !important;
    }

    .stat-student {
        border-left-color: var(--success) !important;
    }

    .stat-quiz {
        border-left-color: var(--info) !important;
    }

    .stat-question {
        border-left-color: var(--warning) !important;
    }

    .dashboard-stat:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg) !important;
    }

    .table th {
        border-top: none;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }

    .badge {
        font-weight: 500;
    }

    .card {
        border-radius: var(--border-radius);
    }

    .card-header {
        border-bottom: 1px solid var(--gray-200);
    }

    .progress {
        border-radius: 10px;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize performance chart
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const performanceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Excellent', 'Good', 'Needs Improvement'],
                datasets: [{
                    data: [{{ excellent_count }}, {{ good_count }}, {{ poor_count }}],
        backgroundColor: [
        'rgba(40, 167, 69, 0.8)',
        'rgba(255, 193, 7, 0.8)',
        'rgba(220, 53, 69, 0.8)'
    ],
        borderColor: [
        'rgba(40, 167, 69, 1)',
        'rgba(255, 193, 7, 1)',
        'rgba(220, 53, 69, 1)'
    ],
        borderWidth: 1
                }]
            },
        options: {
        cutout: '70%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            }
        },
        animation: {
            animateScale: true,
            animateRotate: true
        }
    }
        });

    // Search functionality
    const searchInput = document.getElementById('searchInput');
    const quizFilter = document.getElementById('quizFilter');
    const resultsTable = document.getElementById('resultsTable');
    const rows = resultsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    function filterResults() {
        const searchText = searchInput.value.toLowerCase();
        const quizValue = quizFilter.value;

        for (let i = 0; i < rows.length; i++) {
            const quizName = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
            const studentName = rows[i].getElementsByTagName('td')[1].textContent.toLowerCase();
            const quizId = rows[i].getElementsByTagName('td')[0].getAttribute('data-quiz-id') || '';

            const matchesSearch = quizName.includes(searchText) || studentName.includes(searchText);
            const matchesQuiz = quizValue === '' || quizId === quizValue;

            rows[i].style.display = (matchesSearch && matchesQuiz) ? '' : 'none';
        }
    }

    searchInput.addEventListener('keyup', filterResults);
    quizFilter.addEventListener('change', filterResults);

    // Add animation to cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
    });
</script>
{% endblock %}